# SQL Terminal Feature

## Overview

The SQL Terminal is a V2 feature that provides a full SQL interface for PocketBase. It allows users to execute SQL queries directly against the database, with support for both raw SQL and AI-generated SQL queries. The SQL Terminal bridges the gap between PocketBase's filter syntax and traditional SQL, enabling complex operations like JOINs, aggregations, and DDL operations.

## Features

- **Direct SQL Execution** - Execute raw SQL queries against PocketBase collections
- **AI-Powered SQL Generation** - Describe what you want in natural language, get SQL
- **Schema Browser** - Visual exploration of all collections and their fields
- **Query History** - Automatically saves recent queries with local storage
- **Results Table** - Dynamic display with sorting, export (CSV/JSON), and copy
- **Dual Mode UI** - Switch between SQL and AI modes seamlessly
- **DDL Operations** - CREATE, ALTER, DROP tables that map to PocketBase collections
- **Safety Features** - Confirmation required for destructive operations, system table protection

## How It Works

### SQL to PocketBase Mapping

The SQL Terminal doesn't execute raw SQL against SQLite directly (except for SELECT). Instead, it translates SQL operations into PocketBase API calls:

| SQL Operation | PocketBase Action |
|---------------|-------------------|
| `SELECT` | Direct SQLite query (read-only) |
| `INSERT` | Creates a new record via Records API |
| `UPDATE` | Updates records via Records API |
| `DELETE` | Deletes records via Records API |
| `CREATE TABLE` | Creates a new PocketBase collection |
| `ALTER TABLE` | Modifies collection schema |
| `DROP TABLE` | Deletes a PocketBase collection |

This approach ensures:
- All PocketBase features work (hooks, validation, files, etc.)
- Collection rules are respected
- System integrity is maintained

### Type Mapping

SQL types are automatically mapped to PocketBase field types:

| SQL Type | PocketBase Type |
|----------|-----------------|
| `VARCHAR`, `TEXT`, `CHAR` | `text` |
| `INT`, `INTEGER`, `BIGINT` | `number` |
| `FLOAT`, `DOUBLE`, `DECIMAL` | `number` |
| `BOOLEAN`, `BOOL` | `bool` |
| `DATE`, `DATETIME`, `TIMESTAMP` | `autodate` |
| `JSON`, `JSONB` | `json` |
| `BLOB` | `file` |

## Setup

No additional setup is required. The SQL Terminal uses the same AI configuration as the AI Query feature:

1. Ensure AI Query is configured (Settings â†’ AI Query)
2. Navigate to SQL Terminal in the sidebar (terminal icon)
3. Start querying!

## Usage Guide

### Direct SQL Mode

1. Click the **SQL** button in the mode toggle
2. Enter your SQL query in the editor
3. Press **Ctrl+Enter** or click **Run** to execute

#### SELECT Queries

```sql
-- Simple query
SELECT * FROM users WHERE status = 'active';

-- With JOIN
SELECT o.*, u.email 
FROM orders o 
JOIN users u ON o.user_id = u.id 
WHERE o.total > 100;

-- Aggregation
SELECT status, COUNT(*) as count, SUM(total) as revenue 
FROM orders 
GROUP BY status;
```

#### INSERT Queries

```sql
-- Insert new record
INSERT INTO products (name, price, status) 
VALUES ('Widget', 29.99, 'active');

-- Note: 'id' is auto-generated by PocketBase if not provided
```

#### UPDATE Queries

```sql
-- Update records
UPDATE products 
SET price = 24.99, status = 'sale' 
WHERE name = 'Widget';
```

#### DELETE Queries

```sql
-- Delete records (requires confirmation)
DELETE FROM orders WHERE status = 'cancelled';
```

#### CREATE TABLE (Collection)

```sql
-- Creates a PocketBase collection with specified fields
CREATE TABLE products (
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10,2),
    quantity INTEGER DEFAULT 0,
    active BOOLEAN DEFAULT true,
    metadata JSON
);
```

#### ALTER TABLE (Modify Collection)

```sql
-- Add column
ALTER TABLE products ADD COLUMN category VARCHAR(100);

-- Note: Other ALTER operations have limited support
```

#### DROP TABLE (Delete Collection)

```sql
-- Delete collection (requires confirmation)
DROP TABLE old_products;
```

### AI Mode

1. Click the **AI** button in the mode toggle
2. Describe what you want in natural language
3. Click **Generate & Execute**

#### Example AI Queries

- "Show me all orders from the last week with their customer names"
- "Create a table for tracking inventory with name, quantity, and location"
- "Update all products with price over 100 to have a 10% discount"
- "Count orders by status for this month"

## API Reference

### POST /api/sql/execute

Execute raw SQL against the database.

**Request:**
```json
{
    "sql": "SELECT * FROM users WHERE status = 'active'",
    "confirm": false
}
```

**Fields:**
- `sql` (required): SQL statement to execute
- `confirm` (optional): Set to `true` to confirm destructive operations

**Response:**
```json
{
    "rows": [
        {"id": "abc123", "email": "user@example.com", "status": "active"}
    ],
    "columns": ["id", "email", "status"],
    "totalRows": 1,
    "rowsAffected": 0,
    "message": ""
}
```

### POST /api/sql/ai

Generate SQL from natural language and optionally execute it.

**Request:**
```json
{
    "query": "Show me all active users",
    "execute": true
}
```

**Fields:**
- `query` (required): Natural language description
- `execute` (optional): Whether to execute the generated SQL

**Response:**
```json
{
    "sql": "SELECT * FROM users WHERE status = 'active'",
    "rows": [...],
    "columns": ["id", "email", "status"],
    "totalRows": 10
}
```

### GET /api/sql/schema

Get the database schema for the schema browser.

**Response:**
```json
{
    "collections": [
        {
            "name": "users",
            "type": "auth",
            "fields": [
                {"name": "email", "type": "email"},
                {"name": "name", "type": "text"},
                {"name": "status", "type": "select"}
            ]
        }
    ]
}
```

## Safety Features

### Confirmation Required

The following operations require `confirm: true` in the API request (UI shows a confirmation dialog):

- `DELETE` statements
- `DROP TABLE` statements
- `TRUNCATE` statements
- `ALTER TABLE` statements

### Protected Tables

System tables (starting with `_`) are protected:
- `_superusers`
- `_externalAuths`
- `_authOrigins`
- `_mfas`
- `_otps`
- `_params`

Attempting to modify these tables will result in an error.

### DELETE Without WHERE

DELETE statements without a WHERE clause are blocked:

```sql
-- This will be blocked
DELETE FROM products;

-- Use this instead (still requires confirmation)
DELETE FROM products WHERE 1=1;
```

## Query History

Queries are automatically saved to local storage:
- Last 50 queries are retained
- Includes both SQL and AI queries
- Click on history item to restore
- Search through history
- Clear all with one click

## Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| `Ctrl+Enter` | Execute query |
| `Tab` | Insert 2 spaces (in SQL editor) |

## Export Options

Results can be exported in multiple formats:
- **CSV** - Comma-separated values for spreadsheets
- **JSON** - Structured data format
- **Copy** - Copy JSON to clipboard

## Troubleshooting

### "Destructive operation requires confirmation"

This is a safety feature. Either:
1. Use the UI which shows a confirmation dialog, or
2. Include `confirm: true` in your API request

### "Cannot modify system collection"

System collections (prefixed with `_`) are protected. These are PocketBase's internal tables.

### "Invalid SQL syntax"

The SQL parser supports standard SQL. Ensure your query is valid. Some advanced features may not be supported.

### "Collection not found"

Check that the table/collection name exists. Use the Schema Explorer to see available collections.

### Query Execution is Slow

For large result sets:
1. Add LIMIT clause to your SELECT
2. Use specific WHERE conditions
3. Consider creating indexes via PocketBase's collection settings

## Architecture

### Backend Components

- **`services/sql/parser.go`** - SQL statement parser
- **`services/sql/mapper.go`** - SQL type to PocketBase field mapper
- **`services/sql/executor.go`** - SQL execution engine
- **`apis/sql_terminal.go`** - REST API endpoints

### Frontend Components

- **`ui/src/pages/SQLTerminal.svelte`** - Main terminal page
- **`ui/src/components/sql/SQLEditor.svelte`** - Code editor
- **`ui/src/components/sql/SchemaExplorer.svelte`** - Schema browser
- **`ui/src/components/sql/ResultsTable.svelte`** - Results display
- **`ui/src/components/sql/QueryHistory.svelte`** - History dropdown
- **`ui/src/stores/sql.js`** - State management

## Limitations

### Current Limitations

1. **Subqueries** - Limited support for nested SELECT statements
2. **Complex JOINs** - Only INNER JOIN and LEFT JOIN are fully supported
3. **Stored Procedures** - Not supported (use PocketBase hooks instead)
4. **Transactions** - Individual statements only, no multi-statement transactions
5. **Views** - Not currently supported for CREATE VIEW

### SQLite-Specific Notes

Since PocketBase uses SQLite:
- Use `||` for string concatenation (not `+`)
- LIMIT/OFFSET syntax is SQLite-style
- Date functions are SQLite-specific (`datetime()`, `date()`, etc.)

## Best Practices

### Performance

1. Always use WHERE clauses to limit results
2. SELECT only needed columns instead of `*`
3. Use LIMIT for large tables
4. Add indexes via PocketBase UI for frequently filtered columns

### Security

1. Never expose the SQL Terminal API to untrusted users
2. Use collection rules to control access
3. Review AI-generated SQL before executing
4. Be cautious with DDL operations

### Query Writing

1. Test SELECT before UPDATE/DELETE with the same WHERE clause
2. Use aliases for readability in complex queries
3. Keep queries focused on single operations
4. Use the Schema Explorer to verify field names

## Related Documentation

- [AI Query Feature](./AI_QUERY_FEATURE.md)
- [PocketBase Filter Syntax](https://pocketbase.io/docs/api-records/#filtering)
- [SQLite Documentation](https://www.sqlite.org/lang.html)

